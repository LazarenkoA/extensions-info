{"ast":null,"code":"var _jsxFileName = \"D:\\\\GIT\\\\1\\u0441-extensions-info\\\\frontend\\\\src\\\\services\\\\contexWebSocket.js\",\n  _s = $RefreshSig$(),\n  _s2 = $RefreshSig$();\nimport React, { createContext, useContext, useEffect, useRef, useState } from 'react';\nimport { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\nconst WS_URL = process.env.REACT_WS_URL || 'http://localhost:8080/api/v1/ws';\nconst WebSocketContext = /*#__PURE__*/createContext(null);\nexport const WebSocketProvider = ({\n  children\n}) => {\n  _s();\n  const [messages, setMessages] = useState([]);\n  const wsRef = useRef(null);\n  const heartbeatRef = useRef(null);\n  const openWSConn = () => {\n    const ws = new WebSocket(WS_URL); // твой эндпоинт\n    wsRef.current = ws;\n    ws.onopen = () => {\n      console.log(\"✅ WS connected\");\n      // запускаем keepalive\n      clearInterval(heartbeatRef.current); // очистим старый\n      heartbeatRef.current = setInterval(() => {\n        if (ws.readyState === WebSocket.OPEN) {\n          ws.send(JSON.stringify({\n            type: \"ping\"\n          }));\n        }\n        if (ws.readyState === WebSocket.CLOSED) {\n          console.log(\"🔌 write to closed WS\");\n          openWSConn();\n        }\n      }, 5000); // каждые 5 сек\n    };\n    ws.onmessage = event => {\n      //setMessages((prev) =>   [...prev, event.data] );\n    };\n    ws.onerror = err => {\n      console.error(\"❌ WS error\", err);\n    };\n  };\n\n  // useEffect(() => {\n  //     console.log(messages)\n  // }, [messages])\n\n  useEffect(() => {\n    openWSConn();\n    if (wsRef.current) {\n      wsRef.current.onclose = () => {\n        console.log(\"🔌 WS closed\");\n      };\n    }\n    return () => {\n      var _wsRef$current;\n      (_wsRef$current = wsRef.current) === null || _wsRef$current === void 0 ? void 0 : _wsRef$current.close();\n      clearInterval(heartbeatRef.current);\n    };\n  }, []);\n  const sendMessage = msg => {\n    var _wsRef$current2;\n    if (((_wsRef$current2 = wsRef.current) === null || _wsRef$current2 === void 0 ? void 0 : _wsRef$current2.readyState) === WebSocket.OPEN) {\n      wsRef.current.send(JSON.stringify(msg));\n    }\n  };\n  return /*#__PURE__*/_jsxDEV(WebSocketContext.Provider, {\n    value: {\n      messages,\n      sendMessage\n    },\n    children: children\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 65,\n    columnNumber: 9\n  }, this);\n};\n_s(WebSocketProvider, \"dSf6Oa72/O0WmqOWhhn6O+jYtLw=\");\n_c = WebSocketProvider;\nexport const useWebSocket = () => {\n  _s2();\n  return useContext(WebSocketContext);\n};\n_s2(useWebSocket, \"gDsCjeeItUuvgOWf1v4qoK9RF6k=\");\nvar _c;\n$RefreshReg$(_c, \"WebSocketProvider\");","map":{"version":3,"names":["React","createContext","useContext","useEffect","useRef","useState","jsxDEV","_jsxDEV","WS_URL","process","env","REACT_WS_URL","WebSocketContext","WebSocketProvider","children","_s","messages","setMessages","wsRef","heartbeatRef","openWSConn","ws","WebSocket","current","onopen","console","log","clearInterval","setInterval","readyState","OPEN","send","JSON","stringify","type","CLOSED","onmessage","event","onerror","err","error","onclose","_wsRef$current","close","sendMessage","msg","_wsRef$current2","Provider","value","fileName","_jsxFileName","lineNumber","columnNumber","_c","useWebSocket","_s2","$RefreshReg$"],"sources":["D:/GIT/1с-extensions-info/frontend/src/services/contexWebSocket.js"],"sourcesContent":["\r\nimport React, { createContext, useContext, useEffect, useRef, useState } from 'react';\r\n\r\nconst WS_URL = process.env.REACT_WS_URL || 'http://localhost:8080/api/v1/ws';\r\nconst WebSocketContext = createContext(null);\r\n\r\nexport const WebSocketProvider = ({ children }) => {\r\n    const [messages, setMessages] = useState([]);\r\n    const wsRef = useRef(null);\r\n    const heartbeatRef = useRef(null);\r\n\r\n    const openWSConn = () => {\r\n        const ws = new WebSocket(WS_URL); // твой эндпоинт\r\n        wsRef.current = ws;\r\n\r\n        ws.onopen = () => {\r\n            console.log(\"✅ WS connected\");\r\n            // запускаем keepalive\r\n            clearInterval(heartbeatRef.current); // очистим старый\r\n            heartbeatRef.current = setInterval(() => {\r\n                if (ws.readyState === WebSocket.OPEN) {\r\n                    ws.send(JSON.stringify({ type: \"ping\" }));\r\n                }\r\n                if (ws.readyState === WebSocket.CLOSED) {\r\n                    console.log(\"🔌 write to closed WS\");\r\n                    openWSConn();\r\n                }\r\n            }, 5_000); // каждые 5 сек\r\n        };\r\n\r\n        ws.onmessage = (event) => {\r\n            //setMessages((prev) =>   [...prev, event.data] );\r\n        };\r\n\r\n        ws.onerror = (err) => {\r\n            console.error(\"❌ WS error\", err);\r\n        };\r\n    }\r\n\r\n    // useEffect(() => {\r\n    //     console.log(messages)\r\n    // }, [messages])\r\n\r\n    useEffect(() => {\r\n       openWSConn()\r\n        if(wsRef.current) {\r\n            wsRef.current.onclose = () => {\r\n                console.log(\"🔌 WS closed\");\r\n            };\r\n        }\r\n\r\n       return () => {\r\n          wsRef.current?.close();\r\n          clearInterval(heartbeatRef.current);\r\n       };\r\n    }, []);\r\n\r\n    const sendMessage = (msg) => {\r\n        if (wsRef.current?.readyState === WebSocket.OPEN) {\r\n            wsRef.current.send(JSON.stringify(msg));\r\n        }\r\n    };\r\n\r\n    return (\r\n        <WebSocketContext.Provider value={{ messages, sendMessage }}>\r\n            {children}\r\n        </WebSocketContext.Provider>\r\n    );\r\n};\r\n\r\nexport const useWebSocket = () => useContext(WebSocketContext);\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}